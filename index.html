<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Review</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">

        <!-- Loading Bootstrap -->
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
        <!-- Loading Flat UI -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/flat-ui/2.3.0/css/flat-ui.css" rel="stylesheet">
        <link href="assets/css/style.css" rel="stylesheet">
    </head>
    <body>
        <noscript>
            You need to enable JavaScript to run this app.
        </noscript>
        <div class="wrapper">
            <div id="formAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
                <div id="error-message"></div> <!-- Error message is dynamically generated -->
            </div>
            <h2>Welcome to online spreadsheet</h2>
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" style="display:inline-block;">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#loginbox">Login</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#signupbox">Sign Up</a>
                </li>
            </ul>
            <div class="tab-content">
                <div class="tab-pane fade show active" id="loginbox">
                    <div class="card">
                        <div class="card-body">
                            <h4>Please login or create a new account by pressing sign up tab</h4>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">@</span>
                                </div>
                                <input type="text" id="login-email" class="form-control" name="username" placeholder="Email Address" required autofocus="" />                                    
                            </div>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">#</span>
                                </div>
                                <input type="password" id="login-password" class="form-control" name="password" placeholder="Password" required/>      
                            </div>
                            <button id="btnlogin" class="btn btn-lg btn-primary mb-2" type="submit">Login</button>   
                            <div class="form-group">
                                <div class="col-md-12 control">
                                    <div style="border-top: 1px solid#888; padding-top:15px; font-size:85%" >
                                        Don't have an account! 
                                        <a id="signuplink" href="#signupbox">
                                            Sign Up Here
                                        </a>
                                    </div>
                                </div>
                            </div>   
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="signupbox">
                    <div class="card">
                        <div class="card-body" >
                            <h4>Sign Up</h4>
                            <div class="form-group">
                                <label for="firstname" class="col-md-3 control-label">First Name</label>
                                <div class="col-md-9">
                                    <input id="signup-fn" type="text" class="form-control" name="firstname" placeholder="First Name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="lastname" class="col-md-3 control-label">Last Name</label>
                                <div class="col-md-9">
                                    <input id="signup-ln" type="text" class="form-control" name="lastname" placeholder="Last Name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email" class="col-md-3 control-label">Email</label>
                                <div class="col-md-9">
                                    <input id="signup-email" type="text" class="form-control" name="email" placeholder="Email Address">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password" class="col-md-3 control-label">Password</label>
                                <div class="col-md-9">
                                    <input id="signup-password" type="password" class="form-control" name="passwd" placeholder="Password">
                                    <small id="passwordHelpBlock" class="form-text text-muted">
                                        Your password must be 8-20 characters long, contain letters and numbers.
                                    </small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password" class="col-md-3 control-label">Confirm Password</label>
                                <div class="col-md-9">
                                    <input type="password" class="form-control" name="passwd" placeholder="Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <!-- Button -->                                        
                                <div class="col-md-offset-3 col-md-9">
                                    <button id="btnsignup" type="button" class="btn btn-info">&nbsp Sign Up</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script>
            var login_email     = document.getElementById("login-email");
            var login_password  = document.getElementById("login-password");
            var signup_email    = document.getElementById("signup-email");
            var signup_password = document.getElementById("signup-password");
            var signup_fn       = document.getElementById("signup-fn");
            var signup_ln       = document.getElementById("signup-ln");
            var loginbtn        = document.getElementById("btnlogin");
            var signupbtn       = document.getElementById("btnsignup");

            //Activate signup tab when click sign up link
            $('#signuplink').on('click', function (e) {
                e.preventDefault()
                $('a[href="#signupbox"]').tab('show')
            })
            // Initialize Firebase
            var config = {
                apiKey: "AIzaSyD4Km5Qn83--tP7laJ5kN4Ea0OE1yr97Ls",
                authDomain: "fb-review.firebaseapp.com",
                databaseURL: "https://fb-review.firebaseio.com",
                projectId: "fb-review",
                storageBucket: "fb-review.appspot.com",
                messagingSenderId: "363032018748"
            };
            firebase.initializeApp(config);
                
            // Login Event
            loginbtn.addEventListener('click', function(){
                var email = login_email.value;
                var password = login_password.value;
                var auth = firebase.auth();
                //Sign in
                auth.signInWithEmailAndPassword(email, password).catch(function(error) {
                    // Handle Errors here
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    if (errorCode === 'auth/wrong-password') {
                        errorMessage = "Wrong password."
                    } else {
                        errorMessage = "Invalid email address."
                    }
                    $("#formAlert").slideUp(400);    // Hide the Alert
                    $("#error-message").html("<strong>Error!</strong>&nbsp;"+errorMessage);
                    $("#formAlert").slideDown(400);    // Show the Alert
                });
            })
            
            // Sign up event
            signupbtn.addEventListener('click', function(){
                var email = signup_email.value;
                var password = signup_password.value;
                var firstname = signup_fn.value;
                var lastname = signup_ln.value;
                var auth = firebase.auth();
                //Sign in
                auth.createUserWithEmailAndPassword(email, password).then(function success(userData){
                    var uid = userData.uid; // The UID of recently created user on firebase

                    var database = firebase.database();
                    database.ref().child("users/"+uid).set({
                                email: email,
                                displayName: firstname,
                                lastname: lastname
                            });

                }).catch(function(error) {
                    $("#formAlert").slideUp(400);    // Hide the Alert
                    $("#error-message").html("<strong>Error!</strong>&nbsp;"+error.message);
                    $("#formAlert").slideDown(400);    // Show the Alert
                    gototop();
                });
                
            })

            //Add a realtime listener
            firebase.auth().onAuthStateChanged(function(firebaseUser) {
                if (firebaseUser) {
                    var database = firebase.database();
                    var get  = database.ref('users/'+firebaseUser.uid);
                    get.on('value', function(snapshot) {
                        if (snapshot.val().displayName) {
                            window.location = 'home.html?user='+snapshot.val().displayName; //After successful login, user will be redirected to home.html
                        }else{
                            window.location = 'home.html?user=User'; //After successful login, user will be redirected to home.html
                        }
                    });
                }else{
                    console.log('------------------------------------');
                    console.log("Not logged in");
                    console.log('------------------------------------');
                    // logoutbtn.classList.add("d-none");
                }
            })

            function gototop(){
                $('body,html').animate({
                    scrollTop: 0
                }, 400);     
            }
        </script>      
    </body>
</html>