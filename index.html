<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Review</title>
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Adsense -->
        <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
        <script>
        (adsbygoogle = window.adsbygoogle || []).push({
            google_ad_client: "ca-pub-1295444404672591",
            enable_page_level_ads: true
        });
        </script>
        <!-- Loading Bootstrap -->
        <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet">
        <!-- Loading Flat UI -->
        <link href="https://cdnjs.cloudflare.com/ajax/libs/flat-ui/2.3.0/css/flat-ui.css" rel="stylesheet">
        <!-- <link href="assets/css/style.css" rel="stylesheet"> -->
        <!-- <link href="assets/css/login.css" rel="stylesheet"> -->
    </head>
    <body>
        <nav class="navbar navbar-expand-lg navbar-light bg-light">
            <a class="navbar-brand" href="#">Review List</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarText" aria-controls="navbarText" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarText">
                <ul class="navbar-nav mr-auto">
                    <li class="nav-item active">
                        <a class="nav-link" href="#">Home <span class="sr-only">(current)</span></a>
                    </li>
                </ul>
                <span class="navbar-text">
                    <a href="#logintab" class="btn btn-lg btn-success float-right" type="submit">Log In</a>   
                </span>
            </div>
        </nav>
        <noscript>
            You need to enable JavaScript to run this app.
        </noscript>
        <div class="wrapper">
            <!-- <div class="wrapper" id="page-wrapper">  
                <main class="site-main" id="main" role="main">
                    <header class="section section-cover" id="hello">
                        <div class="container">
                            <h2 class="section-cover-heading mb-5">Hi ! I'm a <strong class="d-block bigger">Graphic Designer</strong></h2>
                            <p class="h2 text-center text-white">Hi ! I'm a</p>
                            <div class="text-slideshow" data-effect="fx17">
                                <div class="text-slide current">
                                    <h2 class="title letter-effect">Designer</h2>
                                </div>
                                <div class="text-slide">
                                    <h2 class="title">Biker</h2>
                                </div>
                                <div class="text-slide">
                                    <h2 class="title">Pixeltrooper</h2>
                                </div>
                            </div>
                        </div>
                        <a href="#works" class="btn btn-light btn-next-down">See my work</a>
                    </header>
                </main>
            </div> -->
            <div id="formAlert" class="alert alert-danger alert-dismissible fade show" role="alert" style="display: none;">
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
                </button>
                <div id="error-message"></div> <!-- Error message is dynamically generated -->
            </div>
            <h2>Welcome to online spreadsheet</h2>
            <!-- Nav tabs -->
            <ul class="nav nav-tabs" style="display:inline-block;">
                <li class="nav-item float-left">
                    <a class="nav-link active" id="logintab" data-toggle="tab" href="#loginbox">Login</a>
                </li>
                <li class="nav-item float-left">
                    <a class="nav-link" data-toggle="tab" href="#signupbox">Sign Up</a>
                </li>
            </ul>
            <div class="tab-content">
                <!-- Login -->
                <div class="tab-pane fade show active" id="loginbox">
                    <div class="card">
                        <div class="card-body">
                            <h4>Please login or create a new account by pressing sign up tab</h4>
                            <div class="input-group mb-3">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">@</span>
                                </div>
                                <input type="text" id="login-email" class="form-control" name="username" placeholder="Email Address" required autofocus="" />                                    
                            </div>
                            <div class="input-group">
                                <div class="input-group-prepend">
                                    <span class="input-group-text">#</span>
                                </div>
                                <input type="password" id="login-password" class="form-control" name="password" placeholder="Password" required/>
                            </div>
                            <a href="forget.html" class="mb-3" style="display: block;">Forget Password?</a>  
                            <button id="btnlogin" class="btn btn-lg btn-primary mb-2" type="submit">Login</button>  
                            <div class="form-group">
                                <div class="col-md-12 control">
                                    <div style="border-top: 1px solid#888; padding-top:15px; font-size:85%" >
                                        Don't have an account! 
                                        <a id="signuplink" href="#signupbox">
                                            Sign Up Here
                                        </a>
                                    </div>
                                </div>
                            </div>   
                        </div>
                    </div>
                </div>
                <!-- Sign Up -->
                <div class="tab-pane fade" id="signupbox">
                    <div class="card">
                        <div class="card-body" >
                            <h4>Sign Up</h4>
                            <div class="form-group">
                                <label for="firstname" class="col-md-3 control-label">First Name</label>
                                <div class="col-md-9">
                                    <input id="signup-fn" type="text" class="form-control" name="firstname" placeholder="First Name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="lastname" class="col-md-3 control-label">Last Name</label>
                                <div class="col-md-9">
                                    <input id="signup-ln" type="text" class="form-control" name="lastname" placeholder="Last Name">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="email" class="col-md-3 control-label">Email</label>
                                <div class="col-md-9">
                                    <input id="signup-email" type="text" class="form-control" name="email" placeholder="Email Address">
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password" class="col-md-3 control-label">Password</label>
                                <div class="col-md-9">
                                    <input id="signup-password" type="password" class="form-control" name="passwd" placeholder="Password">
                                    <small id="passwordHelpBlock" class="form-text text-muted">
                                        Your password must be 8-20 characters long, contain letters and numbers.
                                    </small>
                                </div>
                            </div>
                            <div class="form-group">
                                <label for="password" class="col-md-3 control-label">Confirm Password</label>
                                <div class="col-md-9">
                                    <input type="password" class="form-control" name="passwd" placeholder="Password">
                                </div>
                            </div>
                            <div class="form-group">
                                <!-- Button -->                                        
                                <div class="col-md-offset-3 col-md-9">
                                    <button id="btnsignup" type="button" class="btn btn-info">&nbsp Sign Up</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/1.20.3/TweenMax.min.js"></script> -->
        <!-- <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/16327/MorphSVGPlugin.min.js?r=182"></script> -->
        <!-- <script src="assets/js/login.js"></script> -->

        <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
        <script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>        
        <script src="https://www.gstatic.com/firebasejs/4.9.1/firebase.js"></script>
        <script>
            var login_email     = document.getElementById("login-email");
            var login_password  = document.getElementById("login-password");
            var signup_email    = document.getElementById("signup-email");
            var signup_password = document.getElementById("signup-password");
            var signup_fn       = document.getElementById("signup-fn");
            var signup_ln       = document.getElementById("signup-ln");
            var loginbtn        = document.getElementById("btnlogin");
            var signupbtn       = document.getElementById("btnsignup");
            var email = '';
            var password = '';

            //=========== GET parameter, Firstname of user ===============
            function getUrlParams( prop ) {
                var params = {};
                var search = decodeURIComponent( window.location.href.slice( window.location.href.indexOf( '?' ) + 1 ) );
                var definitions = search.split( '&' );

                definitions.forEach( function( val, key ) {
                    var parts = val.split( '=', 2 );
                    params[ parts[ 0 ] ] = parts[ 1 ];
                } );
                return ( prop && prop in params ) ? params[ prop ] : params;
            }
            var loginorlogout = getUrlParams('user');

            //Activate signup tab when click sign up link
            $('#signuplink').on('click', function (e) {
                e.preventDefault()
                $('a[href="#signupbox"]').tab('show')
            })

            // =========== Initialize Firebase =============
            var config = {
                apiKey: "AIzaSyD4Km5Qn83--tP7laJ5kN4Ea0OE1yr97Ls",
                authDomain: "fb-review.firebaseapp.com",
                databaseURL: "https://fb-review.firebaseio.com",
                projectId: "fb-review",
                storageBucket: "fb-review.appspot.com",
                messagingSenderId: "363032018748"
            };
            firebase.initializeApp(config);
                
            //  =============== Login ===================
            loginbtn.addEventListener('click', function(){
                var auth    = firebase.auth();
                email       = login_email.value;
                password    = login_password.value;
                signup_fn   = '';
                signup_ln   = '';
                //Sign in
                auth.signInWithEmailAndPassword(email, password).catch(function(error) {
                    // Handle Errors here
                    var errorCode = error.code;
                    var errorMessage = error.message;
                    errorMessage = errorCode === 'auth/wrong-password' ? "Wrong password." : "Invalid email address. Make sure that you don't have any spaces after your email.";
                    showError(errorMessage);
                });
            })
            
            // ================ Sign up ====================
            signupbtn.addEventListener('click', function(){
                var auth        = firebase.auth();
                email           = signup_email.value;
                password        = signup_password.value;
                signup_fn       = signup_fn.value;
                signup_ln       = signup_ln.value;
                //Sign in
                auth.createUserWithEmailAndPassword(email, password)
                    .catch(function(error) {
                        showError(error.message);
                    });   
            })

            //Add a realtime listener
            firebase.auth().onAuthStateChanged(function(firebaseUser) {
                if (firebaseUser) {
                    // log in
                    var database    = firebase.database();
                    // If new user - sign up
                    if (signup_fn.length > 0 && signup_ln.length > 0) {
                        var db_ref = database.ref().child('users/'+firebaseUser.uid);
                        db_ref.set({
                                    email: email,
                                    displayName: signup_fn,
                                    lastname: signup_ln
                                }).then(function(promise){
                                    window.location = 'home.html?user='+signup_fn; //After successful login, user will be redirected to home.html
                                });
                    }
                    // If old user sign in
                    else{
                        var db_ref      = database.ref('users/'+firebaseUser.uid);
                        db_ref.on('value', function(snapshot) {
                            if (snapshot.val() != null) {
                                if (snapshot.val().displayName) {
                                    window.location = 'home.html?user='+snapshot.val().displayName; //After successful login, user will be redirected to home.html
                                }else{
                                    window.location = 'home.html?user=User'; //After successful login, user will be redirected to home.html
                                }
                            }
                        });
                    }
                }else{
                    // Log out
                    if (typeof loginorlogout !== 'undefined' && loginorlogout == 'logout'){
                        showError("You're not logged in. Please sign in first."); 
                    }
                }
            })

            function showError(errorMessage){
                $("#formAlert").slideUp(400);    // Hide the Alert
                $("#error-message").html("<strong>Error!</strong>&nbsp;"+errorMessage);
                $("#formAlert").slideDown(400);    // Show the Alert
                //Slide to top of the page to show error message
                $('body,html').animate({
                    scrollTop: 0
                }, 400);     
            }
        </script>      
    </body>
</html>